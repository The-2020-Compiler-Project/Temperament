# 第二次阶段报告

## 1、进展

### （1）整体

各部分内容都已基本完成，目前正在进行各模块的测试与对接工作；其中中间代码生成、优化以及目标代码生成模块的对接与测试已完成。词法分析模块单独测试已经完成，生成对应的token序列的txt文件，让其它模块读取作为输入。

文法目前来看加入新的内容可能性不大，各部分对接过程中出现的问题较多，时间有限，我们就完成样例文法的前端与后端实现。其中，目标代码生成环境是单寄存器虚拟机，一开始是打算生成汇编语言，实现过程中发现对浮点型的表示及运算了解甚少，最终选择采用虚拟机指令系统。

### （2）个人进展

这个阶段主要是完成目标代码生成模块的内容以及各模块间的对接工作。已完成主函数的编写，中间代码生成、优化和目标代码生成部分的对接。

目标代码生成的思路如下：

先根据优化后的四元式生成填写对应各变量的活跃信息，然后根据四元式和活跃信息表生成目标代码。这部分需要用到中间代码优化模块的输出四元式以及中间变量表。

该部分新定义的数据结构以及函数如下：

```c++
struct ACT_INF
{
	int num1 = -1;		//活跃信息，1为y，0为n
	int num2 = -1;
	int ans = -1;
};

struct ACT_INF actinf[200];

string RDV[2];				//寄存器状态变量，"0"表示空闲，"X"表示被X占用

vector<vector<string> > Act_synbl;	//活跃信息表

void get_act_inf(vector<vector<string> >& Act_synbl, ACT_INF* actinf, Quatemion* qua_out, int num);        //填写活跃信息表

void make_objectcode(Quatemion* qua_out, ACT_INF* actinf, int num,string* RDV);
 //生成目标代码
```

生成活跃信息表的思路如下：

将优化后的四元式由后向前遍历，若遇到一个非中间变量，先判断它是否已在活跃信息表中，不在则添加并初始化为y。将改变量对应的活跃信息置为活跃信息表中该变量的活跃信息，若该变量在操作数的位置（num1,num2），则将活跃信息表中该变量对应活跃信息置为y；否则置为n。若遇到的是中间变量，先判断它是否已在活跃信息表中，不在则添加并初始化为n，然后执行上述的后续操作。



生成目标代码思路如下：

按顺序遍历四元式

若为表达式四元式，设当前四元式为 (op , B , C , A)

（1）按寄存器状态生成目标代码（RDV为寄存器状态变量，OPT为算法op对应的操作码）

①若RDV==0，则输出 LD R,B 和 OPT R,C

②若RDV==B，则若B(y)，则输出 ST R,B 和 OPT R,C ；否则输出 op R,C

③若RDV==C且op可交换，则若C(y)，则输出 ST R,C 和 OPT R,B ；否则输出 OPT R,B

④若RDV==D（上述三种情况除外），则若D(y)，则输出 ST R,D ; LD R,B ; OPT R,C

（2）变量A申请占用寄存器，即RDV=A；

若为赋值四元式，设当前四元式为 (:= , B , _ , A)

①若RDV==0，则输出 LD R,B ; ST R,A ，然后RDV=B；

②若RDV==B，则输出 ST R,A；

③若RDV==D(D!=B)，则若D(y)，则输出 ST R,D ;LD R,B ;ST R,A；否则输出 LD R,B ; ST R,A；然后RDV=B；

若最后读取的四元式为表达式四元式，则将结果保存。



测试结果：

四元式：

( program , example , _ , _ )  ( + , 10 , b , a )  ( + , a , b , t3 )  ( / , t3 , 2 , t4 )  ( * , t4 , 5 , b )  ( * , c , 2.5 , d )  ( end , example , _ , _ )

得到的活跃信息：

(10,b(y),a(y))  (a(y),b(n),t3(y))  (t3(n),2,t4(y))  (t4(n),5,b(y))  (c(y),2.5,d(y))

生成的目标代码

LD R,10
ADD R,b
ST R,a
ADD R,b
ST R,t3
DIV R,2
ST R,t4
MUL R,5
ST R,b
LD R,c
MUL R,2.5
ST R,d

## 2、问题

本阶段还是发现了优化模块的BUG并进行修复，也就是上阶段中出现的访问权限冲突问题。目标代码生成模块的思路是参照PPT上的内容，所以没有出现太大问题。主要问题还是出现在代码合并中。此前所做的课设内容相对简单，所用的头文件/源文件较少，之间的联系也较为清晰。编译课程设计较为复杂，分工较细致，源文件也较多。本次分工上尽量让各部分独立，接口大多采用了文件I/O的方式，但有些模块还是采用直接调用其它模块中的数据的方式来完成一部分的对接。我先是采用的include “头文件名”的形式将各部分连接，但是实际测试时显示一些数据、函数重复定义。通过上网查询的方式，目前采用extern来使用其它源文件中数据、函数，后来发现可以在各自模块添加一个函数完成本阶段的任务，这样只要在主函数中去调用其它源文件中的任务函数即可，这样避免了大量的重复代码。

## 3、下一步工作

目前中间代码生成、优化和目标代码生成部分已完成对接。下一步就是对其它模块进行合并、测试，完成主函数的编写，然后进行编写课设报告的工作。